<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Saepel - ุงูุฑุฆูุณูุฉ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- ุฃููููุงุช Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- ููู ุงูุชุตููู ุงูุฑุฆูุณู -->
    <link rel="stylesheet" href="assets/css/style.css" />
    <!-- โญ ููู ุชุตููู ูุงุฆูุฉ ุงูุซูุงุซ ููุงุท -->
    <link rel="stylesheet" href="assets/css/postMenu.css" />
    <!-- โญ ููู ุชุตููู ุงููุตุต -->
    <link rel="stylesheet" href="assets/css/stories.css" />
  </head>
  <body class="theme-beige">
    <script>
      (function guardHome() {
        const token =
          localStorage.getItem("token") ||
          localStorage.getItem("jwt") ||
          localStorage.getItem("SAEPEL_TOKEN") ||
          "";
        if (!token) {
          window.location.replace("index.html");
        }
      })();
    </script>
    <!-- ุฎูููุฉ orbs -->
    <div class="bg-orbs">
      <div class="bg-shapes">
        <span class="shape s1"></span>
        <span class="shape s2"></span>
        <span class="shape s3"></span>
      </div>
      <div class="bg-orb orb-1"></div>
      <div class="bg-orb orb-2"></div>
      <div class="bg-orb orb-3"></div>
    </div>

    <div class="app-shell">
      <!-- ุดุฑูุท ุนููู -->
      <header class="top-nav glass">
        <!-- ุฒุฑ ุงููุงุฆูุฉ + ููุฌู -->
        <div class="logo-area">
          <!-- ุฒุฑ ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ุงูุฌุฏูุฏ -->
          <button
            class="icon-btn"
            id="mainMenuBtn"
            type="button"
            title="ุงููุงุฆูุฉ"
            aria-label="ุงููุงุฆูุฉ"
          >
            <i class="fa-solid fa-bars"></i>
          </button>

          <div class="logo-icon">S</div>
          <div class="logo-text">
            <span>Saepel</span>
            <span>ุดุจูุชู ุงูุงุฌุชูุงุนูุฉ ุงูุนุตุฑูุฉ</span>
          </div>
        </div>

        <div class="nav-center">
          <div class="nav-search">
            <input
              type="text"
              id="searchInput"
              placeholder="ุงุจุญุซ ุนู ุฃุดุฎุงุต ุฃู ููุดูุฑุงุช..."
            />
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
        </div>

        <div class="nav-actions">
          <button
            class="icon-btn"
            title="ุจุญุซ"
            id="openSearchBtn"
            type="button"
          >
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
          <!-- โ ุฒุฑ ุงูุฑุณุงุฆู ูุน id -->
          <button
            class="icon-btn"
            title="ุงูุฑุณุงุฆู"
            id="topMessagesBtn"
            type="button"
          >
            <i class="fa-regular fa-message"></i>
          </button>
        </div>
      </header>

      <!-- ุจุญุซ ููุจุซู -->
      <div class="search-overlay" id="searchOverlay">
        <div class="search-modal glass">
          <div class="search-header">
            <div class="search-title">ุจุญุซ</div>
            <button class="icon-btn" id="closeSearchBtn" type="button">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="search-input-wrap">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input
              id="searchQuery"
              type="text"
              placeholder="ุงุจุญุซ ุนู ุตุฏูู ุฃู ูุฌููุนุฉ ุฃู ููุดูุฑ..."
            />
          </div>

          <div class="search-filters" id="searchFilters">
            <button class="chip active" data-type="users">ุฃุดุฎุงุต</button>
            <button class="chip" data-type="groups">ูุฌููุนุงุช</button>
            <button class="chip" data-type="pages">ุตูุญุงุช</button>
            <button class="chip" data-type="posts">ููุดูุฑุงุช</button>
          </div>

          <div class="search-results" id="searchResults"></div>
        </div>
      </div>

      <!-- โ ุตู ุงููุตุต -->
      <section class="stories-row">
        <!-- ูุฑุช ุฅุถุงูุฉ ูุตุฉ -->
        <div class="story-card glass story-add" id="storyAdd">
          <div class="story-inner">
            <div class="story-avatar story-add-avatar">
              <i class="fa-solid fa-plus"></i>
            </div>
            <div class="story-label">ุฅุถุงูุฉ ูุตุฉ</div>
          </div>
        </div>

        <!-- ููุง ุฑุญ ูุฑุณู ุงููุตุต ุฏููุงููููุงู ูู JS -->
        <div class="stories-scroll" id="storiesList"></div>
      </section>

      <!-- ุงูุนููุฏ ุงูุฑุฆูุณู -->
      <main class="main-column">
        <!-- ุฅูุดุงุก ููุดูุฑ -->
        <section class="create-post-card glass">
          <div class="create-post-top">
            <div class="avatar-lg" id="currentUserAvatar">A</div>
            <div class="fake-input" id="openCreateModal">
              <span id="createPlaceholder">ุดู ุญุงุจุจ ุชุดุงุฑู ุงููููุ</span>
              <i class="fa-regular fa-pen-to-square"></i>
            </div>
          </div>

          <div class="create-post-actions">
            <button class="cp-btn" id="cpMedia">
              <i class="fa-solid fa-photo-film"></i>
              <span>ุตูุฑุฉ / ููุฏูู</span>
            </button>
            <button class="cp-btn" id="cpLink">
              <i class="fa-solid fa-link"></i>
              <span>ุฑุงุจุท</span>
            </button>
            <button class="cp-btn">
              <i class="fa-regular fa-face-smile"></i>
              <span>ุญุงูุฉ</span>
            </button>
          </div>

          <!-- ุฑุณุงุฆู ุงููุฌุงุญ / ุงูุฎุทุฃ -->
          <div id="createMsg" class="create-msg"></div>
        </section>

        <!-- ููุง JS ุฑุญ ูุนุฑุถ ุงูููุดูุฑุงุช ูู ุงูุจุงู ุฅูุฏ -->
        <div id="posts"></div>
      </main>
    </div>

    <!-- ุฒุฑ ุนุงุฆู (ุฏูุณูุชูุจ ููุท) -->
    <button class="fab-new-post" id="fabOpen">
      <i class="fa-solid fa-plus"></i>
    </button>

    <!-- ุดุฑูุท ุณููู ููุฌูุงู -->
    <nav class="bottom-nav glass">
      <div class="bottom-nav-btn active" data-nav="home" id="bottomHome">
        <i class="fa-solid fa-house"></i>
        <span>ุงูุฑุฆูุณูุฉ</span>
      </div>
      <div class="bottom-nav-btn">
        <i class="fa-solid fa-clapperboard-play"></i>
        <span>ุฑููุฒ</span>
      </div>
      <div class="bottom-nav-btn add-btn" id="bottomAdd">
        <i class="fa-solid fa-circle-plus"></i>
        <span>ููุดูุฑ</span>
      </div>
      <div class="bottom-nav-btn">
        <i class="fa-regular fa-bell"></i>
        <span>ุฅุดุนุงุฑุงุช</span>
      </div>
      <div class="bottom-nav-btn" id="bottomProfile">
        <i class="fa-regular fa-user"></i>
        <span>ุจุฑููุงูู</span>
      </div>
    </nav>

    <!-- ููุฏุงู ุฅูุดุงุก ููุดูุฑ -->
    <div class="modal-overlay" id="createPostModal">
      <div class="modal glass soft-shadow">
        <div class="modal-header">
          <div class="modal-title">ุฅูุดุงุก ููุดูุฑ</div>
          <button class="modal-close" id="closeModalBtn">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-user">
            <div class="avatar-lg" id="modalUserAvatar">A</div>
            <div class="modal-user-info">
              <span id="modalUserName">ูุณุชุฎุฏู</span>
              <span class="privacy-pill" id="privacyToggle">
                <i class="fa-solid fa-earth-asia"></i>
                ุนุงู
              </span>
            </div>
          </div>

          <textarea id="postText" placeholder="ุดู ุญุงุจุจ ุชูุชุจุ"></textarea>

          <div class="modal-media-row">
            <button
              class="modal-media-btn"
              id="modalAddMediaBtn"
              type="button"
              style="
                background: linear-gradient(135deg, #6e4aff, #00d1ff);
                border: none;
              "
            >
              <i class="fa-solid fa-photo-film"></i>
              <span>ุฅุถุงูุฉ ุตูุฑุฉ / ููุฏูู</span>
            </button>
            <button
              class="modal-media-btn"
              id="modalAddLinkBtn"
              type="button"
              style="
                background: linear-gradient(135deg, #22c55e, #06b6d4);
                border: none;
              "
            >
              <i class="fa-solid fa-link"></i>
              <span>ุฅุถุงูุฉ ุฑุงุจุท</span>
            </button>
          </div>

          <input
            type="file"
            id="postMediaInput"
            accept="image/*,video/*"
            style="display: none"
          />

          <div id="postMediaPreview"></div>

          <input
            type="url"
            id="postLinkInput"
            class="text-input"
            placeholder="ููููู ุฅุถุงูุฉ ุฑุงุจุท (ุงุฎุชูุงุฑู)"
          />

          <div class="modal-footer">
            <button class="btn-primary" id="publishBtn" disabled>ูุดุฑ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- โ ููุฏุงู ุฅูุดุงุก ุณุชูุฑู -->
    <div class="story-create-overlay" id="storyCreateOverlay">
      <div class="story-create-modal">
        <div class="sc-header">
          <h3>ุฅูุดุงุก ุณุชูุฑู</h3>
          <button class="sc-close" id="scCloseBtn" type="button">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="sc-tabs">
          <button
            class="sc-tab sc-tab-active"
            data-tab="media"
            type="button"
          >
            ุตูุฑุฉ / ููุฏูู
          </button>
          <!-- ุฌุงูุฒ ูุงุญูุงู ูู ุญุจูููุง ููุนูู "ูุต ููุท" -->
          <button class="sc-tab" data-tab="text" type="button" style="display:none;">
            ูุต ููุท
          </button>
        </div>

        <!-- ุชุจููุจ ุงูุตูุฑุฉ/ุงูููุฏูู -->
        <div class="sc-body sc-body-active" id="scMediaTab">
          <label class="sc-upload-label">
            <input
              type="file"
              id="scFileInput"
              accept="image/*,video/*"
              hidden
            />
            <i class="fa-solid fa-cloud-arrow-up"></i>
            <span>ุงุฎุชุฑ ุตูุฑุฉ ุฃู ููุฏูู ูู ุฌูุงุฒู</span>
          </label>

          <div class="sc-preview" id="scPreview">
            <span class="sc-preview-placeholder">
              ุณุชุธูุฑ ุงููุนุงููุฉ ููุง ุจุนุฏ ุงุฎุชูุงุฑ ุงูููู
            </span>
          </div>
        </div>

        <!-- ุชุจููุจ ุงููุต ููุท (ุบูุฑ ููุนูู ุญุงููุงู) -->
        <div class="sc-body" id="scTextTab">
          <textarea
            id="scTextInput"
            class="sc-textarea"
            placeholder="ุงูุชุจ ูุต ุงูุณุชูุฑู ููุง..."
          ></textarea>
          <div class="sc-text-preview">
            <div class="sc-text-story" id="scTextStoryPreview">
              ุงูุชุจ ุดูุฆุงู ุฌูููุงู โจ
            </div>
          </div>
        </div>

        <div class="sc-footer">
          <button class="sc-submit-btn" id="scSubmitBtn" type="button">
            ูุดุฑ ุงูุณุชูุฑู
          </button>
        </div>
      </div>
    </div>
    <!-- โ ููุงูุฉ ููุฏุงู ุฅูุดุงุก ุณุชูุฑู -->

    <!-- ===== ูุงุฆูุฉ Saepel ุงูุฌุงูุจูุฉ ===== -->
    <div class="side-menu-overlay" id="sideMenu">
      <div class="side-menu glass soft-shadow">
        <div class="side-menu-header">
          <div class="menu-user">
            <div class="avatar-sm" id="welcomeUser">A</div>
            <div class="menu-user-info">
              <span id="menuUserName">ูุณุชุฎุฏู Saepel</span>
              <span class="menu-user-hint">ูุฑุญุจุงู ุจู ๐</span>
            </div>
          </div>

          <button class="close-menu" id="closeMenuBtn" type="button">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <ul class="menu-list">
          <li class="menu-item" data-action="profile">
            <i class="fa-solid fa-user"></i>
            <span>ูููู ุงูุดุฎุตู</span>
          </li>
          <li class="menu-item" data-action="analytics">
            <i class="fa-solid fa-chart-line"></i>
            <span>ุชุญูููุงุช ุงูุญุณุงุจ</span>
          </li>
          <li class="menu-item" data-action="saved" id="menuSaved">
            <i class="fa-regular fa-bookmark"></i>
            <span>ุงููุญููุธุงุช (Saved)</span>
          </li>
          <li class="menu-item" data-action="messenger">
            <i class="fa-solid fa-comments"></i>
            <span>Messenger ุงูุฏุฑุฏุดุฉ</span>
          </li>
          <li class="menu-item" data-action="explore">
            <i class="fa-solid fa-compass"></i>
            <span>ุงุณุชูุดุงู (Explore)</span>
          </li>
          <li class="menu-item" data-action="play">
            <i class="fa-solid fa-gamepad"></i>
            <span>Saepel Play</span>
          </li>
          <li class="menu-item" data-action="media">
            <i class="fa-solid fa-photo-film"></i>
            <span>ูุฏูุฑ ุงููุณุงุฆุท</span>
          </li>
          <li class="menu-item" data-action="drafts">
            <i class="fa-solid fa-file-pen"></i>
            <span>ุงููุณูุฏุงุช (Drafts)</span>
          </li>
          <li class="menu-item" data-action="security">
            <i class="fa-solid fa-shield-halved"></i>
            <span>ูุฑูุฒ ุงูุฃูุงู</span>
          </li>
          <li class="menu-item" data-action="personalization">
            <i class="fa-solid fa-palette"></i>
            <span>ุงูุชุฎุตูุต ูุงููุธูุฑ</span>
          </li>
          <li class="menu-item" data-action="verification">
            <i class="fa-solid fa-circle-check"></i>
            <span>ุชูุซูู ุงูุญุณุงุจ</span>
          </li>
          <li class="menu-item" data-action="points">
            <i class="fa-solid fa-coins"></i>
            <span>ููุงุท Saepel</span>
          </li>
          <li class="menu-item" data-action="settings">
            <i class="fa-solid fa-gear"></i>
            <span>ุงูุฅุนุฏุงุฏุงุช</span>
          </li>
          <li class="menu-item menu-item-danger" data-action="logout">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- โญโญ Popup ูุงุฆูุฉ ุฎูุงุฑุงุช ุงูููุดูุฑ โญโญ -->
    <div class="post-menu-overlay" id="postMenuOverlay">
      <div class="post-menu-modal">
        <div class="post-menu-header">
          <span>ุฎูุงุฑุงุช ุงูููุดูุฑ</span>
          <button class="post-menu-close" id="postMenuCloseBtn">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="post-menu-options">
          <!-- ูุตุงุญุจ ุงูููุดูุฑ ููุท -->
          <button class="post-menu-item owner-only" data-action="edit">
            <i class="fa-regular fa-pen-to-square"></i>
            <span>ุชุนุฏูู ุงูููุดูุฑ</span>
          </button>

          <button
            class="post-menu-item owner-only danger"
            data-action="delete"
          >
            <i class="fa-regular fa-trash-can"></i>
            <span>ุญุฐู ุงูููุดูุฑ</span>
          </button>

          <!-- ููุฌููุน ููู ุชุญุชุงุฌ ูุณุงุฆุท -->
          <button
            class="post-menu-item has-media"
            data-action="downloadMedia"
          >
            <i class="fa-regular fa-circle-down"></i>
            <span>ุชุญููู ุงูุตูุฑุฉ / ุงูููุฏูู</span>
          </button>

          <!-- ููุฌููุน -->
          <button class="post-menu-item" data-action="copyLink">
            <i class="fa-solid fa-link"></i>
            <span>ูุณุฎ ุฑุงุจุท ุงูููุดูุฑ</span>
          </button>

          <button class="post-menu-item" data-action="copyText">
            <i class="fa-regular fa-copy"></i>
            <span>ูุณุฎ ูุต ุงูููุดูุฑ</span>
          </button>

          <!-- ูุบูุฑ ุตุงุญุจ ุงูููุดูุฑ ููุท -->
          <button
            class="post-menu-item not-owner-only"
            data-action="report"
          >
            <i class="fa-regular fa-flag"></i>
            <span>ุงูุฅุจูุงุบ ุนู ูุฐุง ุงูููุดูุฑ</span>
          </button>

          <button
            class="post-menu-item not-owner-only"
            data-action="hidePost"
          >
            <i class="fa-regular fa-eye-slash"></i>
            <span>ุฅุฎูุงุก ูุฐุง ุงูููุดูุฑ</span>
          </button>

          <button
            class="post-menu-item not-owner-only"
            data-action="unfollowUser"
          >
            <i class="fa-regular fa-user-xmark"></i>
            <span>ุฅูุบุงุก ูุชุงุจุนุฉ ุตุงุญุจ ุงูููุดูุฑ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- โญโญ ููุฏุงู ุชุฃููุฏ ุญุฐู ุงูููุดูุฑ โญโญ -->
    <div class="post-delete-overlay" id="postDeleteOverlay">
      <div class="post-delete-modal">
        <div class="post-delete-icon">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <h2 class="post-delete-title">ุญุฐู ุงูููุดูุฑุ</h2>
        <p class="post-delete-text">
          ูู ุชุชููู ูู ุงุณุชุนุงุฏุฉ ูุฐุง ุงูููุดูุฑ ุจุนุฏ ุญุฐูู. ูู ุฃูุช ูุชุฃูุฏุ
        </p>
        <div class="post-delete-actions">
          <button
            type="button"
            class="post-delete-btn cancel"
            id="cancelDeleteBtn"
          >
            ุฅูุบุงุก
          </button>
          <button
            type="button"
            class="post-delete-btn confirm"
            id="confirmDeleteBtn"
          >
            ูุนูุ ุงุญุฐู
          </button>
        </div>
      </div>
    </div>

    <!-- ๐ถ ููุฏุงู ุชุนุฏูู ุงูููุดูุฑ -->
    <div id="postEditOverlay" class="post-edit-overlay">
      <div class="post-edit-modal">
        <button type="button" id="postEditCloseBtn" class="post-edit-close">
          <i class="fa-solid fa-xmark"></i>
        </button>

        <h3 class="post-edit-title">ุชุนุฏูู ุงูููุดูุฑ โ๏ธ</h3>

        <form id="postEditForm" class="post-edit-form">
          <label class="post-edit-label" for="postEditText">ูุต ุงูููุดูุฑ</label>
          <textarea
            id="postEditText"
            class="post-edit-textarea"
            rows="4"
            placeholder="ุนุฏูู ุงููุต ููุง..."
          ></textarea>

          <!-- ๐ ุงุฎุชูุงุฑ ุงูุฎุตูุตูุฉ (ุนุงู / ุฎุงุต) -->
          <label class="post-edit-label" for="postEditPrivacy">
            ุฎุตูุตูุฉ ุงูููุดูุฑ
          </label>
          <select id="postEditPrivacy" class="post-edit-select">
            <option value="public">ุนุงู</option>
            <option value="private">ุฎุงุต</option>
          </select>
          <!-- ๐ -->

          <label class="post-edit-label" for="postEditMediaInput">
            ุชุบููุฑ ุงูุตูุฑุฉ / ุงูููุฏูู (ุงุฎุชูุงุฑู)
          </label>
          <input
            type="file"
            id="postEditMediaInput"
            class="post-edit-file"
            accept="image/*,video/*"
          />

          <div class="post-edit-actions">
            <span
              id="postEditSaving"
              class="post-edit-saving"
              style="display: none"
              >ุฌุงุฑู ุงูุญูุธ...</span
            >
            <button type="submit" class="post-edit-submit">
              ุญูุธ ุงูุชุนุฏููุงุช
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- โญโญ ููุฏุงู ุงูุฅุจูุงุบ ุนู ููุดูุฑ โญโญ -->
    <div id="reportOverlay" class="report-overlay hidden">
      <div class="report-box">
        <!-- ุฒุฑ ุงูุฅุบูุงู -->
        <button
          class="report-close"
          id="reportCloseBtn"
          type="button"
          aria-label="ุฅุบูุงู"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>

        <h3 class="report-title">ุงูุฅุจูุงุบ ุนู ููุดูุฑ</h3>
        <p class="report-subtitle">
          ุฅุฐุง ูุงู ูุฐุง ุงูููุดูุฑ ูุฎุงูู ุงูููุงุนุฏุ ุงุฎุชุฑ ุงูุณุจุจ ูุณูููู ุจูุฑุงุฌุนุชู.
        </p>

        <label for="reportReason" class="report-label">ุณุจุจ ุงูุฅุจูุงุบ</label>
        <select id="reportReason" class="report-select">
          <option value="">ุงุฎุชุฑ ุงูุณุจุจโฆ</option>
          <option value="spam">ุณุจุงู / ูุญุชูู ูุฒุนุฌ</option>
          <option value="hate">ุฎุทุงุจ ูุฑุงููุฉ ุฃู ุนูุตุฑูุฉ</option>
          <option value="sexual">ูุญุชูู ุฌูุณู ุฃู ุบูุฑ ูุงุฆู</option>
          <option value="violence">ุนูู ุฃู ูุดุงูุฏ ูุฒุนุฌุฉ</option>
          <option value="misinfo">ูุนูููุงุช ูุถููููุฉ</option>
          <option value="self-harm">ุชุญุฑูุถ ุนูู ุฅูุฐุงุก ุงูููุณ</option>
          <option value="other">ุณุจุจ ุขุฎุฑโฆ</option>
        </select>

        <div id="reportOtherWrapper" class="report-other hidden">
          <label for="reportOther" class="report-label">
            ุงุดุฑุญ ุงููุดููุฉ (ุงุฎุชูุงุฑู)
          </label>
          <textarea
            id="reportOther"
            class="report-textarea"
            rows="3"
            placeholder="ุงูุชุจ ูุตููุง ูุฎุชุตุฑูุง ูููุดููุฉโฆ"
          ></textarea>
        </div>

        <div class="report-actions">
          <button
            id="reportCancelBtn"
            class="btn-report-cancel"
            type="button"
          >
            ุฅูุบุงุก
          </button>
          <button
            id="reportSubmitBtn"
            class="btn-report-primary"
            type="button"
          >
            <i class="fa-regular fa-paper-plane"></i>
            <span>ุฅุฑุณุงู ุงูุจูุงุบ</span>
          </button>
        </div>
      </div>
    </div>
    <!-- โญโญ ููุงูุฉ ููุฏุงู ุงูุฅุจูุงุบ โญโญ -->

    <!-- โญโญ ุนุงุฑุถ ุงููุตุต (Story Viewer) โญโญ -->
    <div id="storyViewerOverlay" class="story-viewer-overlay">
      <div class="story-viewer-shell">
        <div class="story-viewer glass soft-shadow">
          <!-- ุดุฑูุท ุงูุชูุฏู -->
          <div class="story-progress">
            <div class="story-progress-bar" id="storyProgressBar"></div>
          </div>

          <!-- ุชุฑููุณุฉ ุงูุนุงุฑุถ -->
          <div class="story-viewer-header">
            <div class="story-viewer-user">
              <div class="story-viewer-avatar" id="storyViewerAvatar">S</div>
              <div class="story-viewer-meta">
                <span id="storyViewerName">ุงุณู ุงููุณุชุฎุฏู</span>
                <div class="story-viewer-sub">
                  <span id="storyViewerTime" class="story-viewer-time">
                    ููุฐ 1 ุณุงุนุฉ
                  </span>
                  <span id="storyViewerViews" class="story-viewer-views">
                    ๐โ๐จ 0
                  </span>
                </div>
              </div>
            </div>

            <div class="story-viewer-actions">
              <!-- โญ ุฒุฑ ุงูุฅุจูุงุบ ุนู ุงููุตุฉ -->
              <button
                type="button"
                class="story-icon-btn"
                id="storyReportBtn"
                title="ุงูุฅุจูุงุบ ุนู ูุฐู ุงููุตุฉ"
              >
                <i class="fa-regular fa-flag"></i>
              </button>

              <button
                type="button"
                class="story-icon-btn"
                id="storyMuteBtn"
                title="ูุชู ุงูุตูุช"
              >
                <i class="fa-solid fa-volume-xmark"></i>
              </button>
              <button
                type="button"
                class="story-icon-btn"
                id="storyCloseBtn"
                title="ุฅุบูุงู"
              >
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

          <!-- ูุญุชูู ุงููุตุฉ -->
          <div class="story-viewer-body">
            <div class="story-viewer-media" id="storyViewerMedia">
              <!-- ูุชู ุญูู ุงูุตูุฑุฉ/ุงูููุฏูู ูู JS -->
            </div>
          </div>

          <!-- ุชูุงุนู: ุฑุฏูุฏ ุงููุนู ู ุงูุฑุฏ -->
          <div class="story-viewer-interactions">
            <div class="story-reactions">
              <button class="reaction-btn" data-reaction="โค๏ธ">โค๏ธ</button>
              <button class="reaction-btn" data-reaction="๐">๐</button>
              <button class="reaction-btn" data-reaction="๐ฎ">๐ฎ</button>
              <button class="reaction-btn" data-reaction="๐ข">๐ข</button>
              <button class="reaction-btn" data-reaction="๐ฅ">๐ฅ</button>
            </div>

            <div class="story-reply-row">
              <input
                type="text"
                id="storyReplyInput"
                class="story-reply-input"
                placeholder="ุงูุชุจ ุฑุณุงูุฉ ุณุฑูุนุฉ ูุตุงุญุจ ุงููุตุฉโฆ"
              />
              <button
                type="button"
                id="storyReplySendBtn"
                class="story-reply-send"
                title="ุฅุฑุณุงู"
              >
                <i class="fa-regular fa-paper-plane"></i>
              </button>
            </div>
          </div>

          <!-- ุฃุฒุฑุงุฑ ุงูุชููู -->
          <div class="story-viewer-footer">
            <button
              type="button"
              class="story-nav-btn"
              id="storyPrevBtn"
              title="ุงูุณุงุจู"
            >
              <i class="fa-solid fa-chevron-right"></i>
            </button>
            <button
              type="button"
              class="story-nav-btn"
              id="storyNextBtn"
              title="ุงูุชุงูู"
            >
              <i class="fa-solid fa-chevron-left"></i>
            </button>
          </div>

          <!-- โ ุดุฑูุท ุฃูุดู ููุณุชูุฑู (ูุดุงูุฏุงุช / ุญุฐู / ุฅุจูุงุบ / ูุชู ูุณุชุฎุฏู) -->
          <div class="story-footer-actions">
            <button class="sf-views-btn" id="sfViewsBtn" type="button">
              <i class="fa-regular fa-eye"></i>
              <span id="sfViewsCount">0</span>
              <span>ูุดุงูุฏุฉ</span>
            </button>

            <div class="sf-actions-right">
              <button
                class="sf-icon-btn"
                id="sfMuteBtn"
                type="button"
                title="ูุชู ูุฐุง ุงููุณุชุฎุฏู"
              >
                <i class="fa-solid fa-bell-slash"></i>
              </button>
              <button
                class="sf-icon-btn sf-danger"
                id="sfReportBtn"
                type="button"
                title="ุงูุฅุจูุงุบ ุนู ูุฐู ุงููุตุฉ"
              >
                <i class="fa-regular fa-flag"></i>
              </button>
              <button
                class="sf-icon-btn sf-danger"
                id="sfDeleteBtn"
                type="button"
                title="ุญุฐู ุงููุตุฉ"
              >
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </div>
          </div>

          <!-- โ ููุญุฉ ุงููุดุงูุฏุงุช -->
          <div class="story-views-panel" id="sfViewsPanel">
            <div class="sf-views-header">
              <span>ุงููุดุงูุฏุงุช</span>
              <button id="sfViewsClose" type="button">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <div class="sf-views-list" id="sfViewsList">
              <!-- ูุชู ุชุนุจุฆุชูุง ูู JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- โญโญ ููุงูุฉ ุนุงุฑุถ ุงููุตุต โญโญ -->

    <!-- โ Toast ููุฅุดุนุงุฑุงุช ุงูุฃูููุฉ -->
    <div id="saeToast" class="sae-toast"></div>

    <!-- ููู ุงูุฌุงูุงุณูุฑุจุช ุงูุฑุฆูุณู -->
    <script src="assets/js/app.js"></script>
    <!-- โญ ููู ุฌุงูุงุณูุฑุจุช ููุงุฆูุฉ ุงูุซูุงุซ ููุงุท -->
    <script src="assets/js/postMenu.js"></script>
    <!-- โญ ููู ุฌุงูุงุณูุฑุจุช ูููุตุต -->
    <script src="assets/js/stories.js"></script>

    <!-- ุฌุงูุงุณูุฑุจุช ุจุณูุท ูููุงุฆูุฉ + ุชุทุจูู ุงููุธูุฑ ุงููุญููุธ -->
    <script>
      const APPEARANCE_KEY = "saepelAppearance";

      (function applyAppearanceFromStorage() {
        try {
          const raw = localStorage.getItem(APPEARANCE_KEY);
          if (!raw) return;
          const s = JSON.parse(raw);
          document.documentElement.classList.toggle("theme-dark", !!s.dark);
          document.body.classList.toggle("body-compact", !!s.compact);
          document.body.classList.toggle("soft-anim", !!s.anim);
        } catch (e) {
          console.warn("cannot apply appearance", e);
        }
      })();

      const mainMenuBtn = document.getElementById("mainMenuBtn");
      const sideMenu = document.getElementById("sideMenu");
      const closeMenuBtn = document.getElementById("closeMenuBtn");
      const menuItems = document.querySelectorAll(".menu-item");

      // โ ุฒุฑ ุงูุฑุณุงุฆู ูู ุงูููุฏุฑ
      const topMessagesBtn = document.getElementById("topMessagesBtn");
      if (topMessagesBtn) {
        topMessagesBtn.addEventListener("click", () => {
          window.location.href = "inbox.html";
        });
      }

      if (mainMenuBtn && sideMenu && closeMenuBtn) {
        mainMenuBtn.addEventListener("click", () => {
          sideMenu.classList.add("active");
        });

        closeMenuBtn.addEventListener("click", () => {
          sideMenu.classList.remove("active");
        });

        sideMenu.addEventListener("click", (e) => {
          if (e.target === sideMenu) {
            sideMenu.classList.remove("active");
          }
        });
      }

      menuItems.forEach((item) => {
        item.addEventListener("click", async () => {
          const action = item.dataset.action;

          switch (action) {
            case "profile":
              window.location.href = "profile.html";
              break;

            case "saved":
              // ุนุฑุถ ุงููุญููุธุงุช ุฏุงุฎู ููุณ ุงูุตูุญุฉ ุจุฏู ูุชุญ ุตูุญุฉ ุฌุฏูุฏุฉ
              if (typeof fetchSavedPostIds === "function") {
                try {
                  await fetchSavedPostIds();
                  if (typeof loadSavedPosts === "function") {
                    await loadSavedPosts();
                  }
                  if (typeof showToast === "function") {
                    showToast("ุชู ุนุฑุถ ุงููุญููุธุงุช ๐", "success");
                  }
                } catch (e) {
                  console.error(e);
                  if (typeof showToast === "function") {
                    showToast("ุชุนุฐุฑ ุชุญููู ุงููุญููุธุงุช", "error");
                  }
                }
              }
              break;

            case "personalization":
              window.location.href = "appearance.html";
              break;

            case "messenger":
              // โ ุงูุชุญ ุตูุญุฉ ุงูุฑุณุงุฆู
              window.location.href = "inbox.html";
              break;

            case "logout":
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              if (typeof showToast === "function") {
                showToast("ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ โ", "success");
                setTimeout(() => {
                  window.location.href = "login.html";
                }, 800);
              } else {
                window.location.href = "login.html";
              }
              break;

            default:
              if (typeof showToast === "function") {
                showToast("ูุฐู ุงูููุฒุฉ ููุฏ ุงูุชุทููุฑ ูู Saepel ๐ง");
              }
              break;
          }

          sideMenu.classList.remove("active");
        });
      });
    </script>

    <script>
      (function initSearch() {
        const openBtn = document.getElementById("openSearchBtn");
        const overlay = document.getElementById("searchOverlay");
        const closeBtn = document.getElementById("closeSearchBtn");
        const input = document.getElementById("searchQuery");
        const results = document.getElementById("searchResults");
        const filters = document.getElementById("searchFilters");

        if (!openBtn || !overlay || !closeBtn || !input || !results || !filters) return;

        function getToken() {
          return (
            localStorage.getItem("token") ||
            localStorage.getItem("jwt") ||
            localStorage.getItem("SAEPEL_TOKEN") ||
            ""
          );
        }

        let currentType = "users";
        let typingTimer = null;
        let cachedSpaces = null;

        function setActiveChip(type) {
          currentType = type;
          filters.querySelectorAll(".chip").forEach((c) => {
            c.classList.toggle("active", c.dataset.type === type);
          });
          results.innerHTML = "";
          if (input.value.trim()) {
            handleSearch();
          }
        }

        filters.addEventListener("click", (e) => {
          const btn = e.target.closest(".chip");
          if (!btn) return;
          setActiveChip(btn.dataset.type);
        });

        function showEmpty(msg) {
          results.innerHTML = `<div class="search-empty">${msg}</div>`;
        }

        async function searchUsers(q) {
          const token = getToken();
          if (!token) {
            showEmpty("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ููุจุญุซ.");
            return;
          }
          const base = window.API_BASE || window.location.origin;
          const res = await fetch(`${base}/api/users/search?q=${encodeURIComponent(q)}`, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            showEmpty("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ.");
            return;
          }
          const data = await res.json();
          const users = Array.isArray(data.users) ? data.users : [];
          if (!users.length) {
            showEmpty("ูุง ุชูุฌุฏ ูุชุงุฆุฌ.");
            return;
          }
          results.innerHTML = users
            .map((u) => {
              const name = u.fullName || u.name || u.username || u.email || "ูุณุชุฎุฏู";
              const avatar = u.avatar || u.profilePic || u.photo || "";
              const letter = String(name).trim().charAt(0) || "S";
              const img = avatar
                ? `<img src="${avatar}" alt="${name}" />`
                : `${letter}`;
              const handle = u.username
                ? "@" + u.username
                : u.publicId
                ? u.publicId
                : u._id
                ? "ID: " + String(u._id).slice(-6)
                : "";
              return `
                <div class="search-item">
                  <div class="avatar">${img}</div>
                  <div class="meta">
                    <div>${name}</div>
                    <div>${handle}</div>
                  </div>
                </div>
              `;
            })
            .join("");
        }

        async function searchPosts(q) {
          const base = window.API_BASE || window.location.origin;
          const token = getToken();
          const headers = token ? { Authorization: "Bearer " + token } : {};
          const res = await fetch(`${base}/api/posts/search?q=${encodeURIComponent(q)}`, {
            headers,
          });
          if (!res.ok) {
            showEmpty("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ.");
            return;
          }
          const data = await res.json();
          const posts = Array.isArray(data.posts) ? data.posts : [];
          if (!posts.length) {
            showEmpty("ูุง ุชูุฌุฏ ูุชุงุฆุฌ.");
            return;
          }
          results.innerHTML = posts
            .map((p) => {
              const user = p.user?.username || "ูุณุชุฎุฏู";
              const text = (p.text || "").slice(0, 80) || "ููุดูุฑ ุจุฏูู ูุต";
              const avatar = p.user?.avatar || "";
              const letter = String(user).trim().charAt(0) || "S";
              const img = avatar ? `<img src="${avatar}" alt="${user}" />` : `${letter}`;
              return `
                <div class="search-item">
                  <div class="avatar">${img}</div>
                  <div class="meta">
                    <div>${user}</div>
                    <div>${text}</div>
                  </div>
                </div>
              `;
            })
            .join("");
        }

        async function loadSpaces() {
          if (cachedSpaces) return cachedSpaces;
          const token = getToken();
          if (!token) return [];
          const base = window.API_BASE || window.location.origin;
          const res = await fetch(`${base}/api/chat/spaces`, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) return [];
          const data = await res.json();
          cachedSpaces = Array.isArray(data) ? data : [];
          return cachedSpaces;
        }

        async function searchSpaces(q, kind) {
          const spaces = await loadSpaces();
          const filtered = spaces.filter((s) => {
            if (kind === "groups" && s.type !== "group") return false;
            if (kind === "pages" && s.type !== "channel") return false;
            const t = (s.title || "").toLowerCase();
            const u = (s.username || "").toLowerCase();
            return t.includes(q.toLowerCase()) || u.includes(q.toLowerCase());
          });
          if (!filtered.length) {
            showEmpty("ูุง ุชูุฌุฏ ูุชุงุฆุฌ.");
            return;
          }
          results.innerHTML = filtered
            .map((s) => {
              const name = s.title || s.username || "Space";
              const avatar = s.avatar || "";
              const letter = String(name).trim().charAt(0) || "S";
              const img = avatar ? `<img src="${avatar}" alt="${name}" />` : `${letter}`;
              const subtitle = s.type === "channel" ? "ุตูุญุฉ" : "ูุฌููุนุฉ";
              return `
                <div class="search-item">
                  <div class="avatar">${img}</div>
                  <div class="meta">
                    <div>${name}</div>
                    <div>${subtitle}</div>
                  </div>
                </div>
              `;
            })
            .join("");
        }

        function handleSearch() {
          const q = input.value.trim();
          if (!q) {
            showEmpty("ุงูุชุจ ูููุฉ ููุจุญุซ.");
            return;
          }
          if (currentType === "users") {
            searchUsers(q);
          } else if (currentType === "posts") {
            searchPosts(q);
          } else if (currentType === "groups" || currentType === "pages") {
            searchSpaces(q, currentType);
          } else {
            showEmpty("ูุฐุง ุงูููุน ูู ุงูุจุญุซ ููุฏ ุงูุชุทููุฑ.");
          }
        }

        input.addEventListener("input", () => {
          clearTimeout(typingTimer);
          typingTimer = setTimeout(handleSearch, 300);
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            handleSearch();
          }
        });

        openBtn.addEventListener("click", () => {
          overlay.classList.add("active");
          setTimeout(() => input.focus(), 50);
        });

        closeBtn.addEventListener("click", () => {
          overlay.classList.remove("active");
          results.innerHTML = "";
          input.value = "";
        });

        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeBtn.click();
        });
      })();
    </script>
  </body>
</html>
