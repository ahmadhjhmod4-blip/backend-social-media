<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>إنشاء حساب - Saepel</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
          circle at top left,
          #28357a 0,
          #050814 40%,
          #000 100%
        );
        color: #f5f7ff;
        /* كان overflow: hidden وسبّب مشكلة عدم التمرير */
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px 12px;
      }

      .bg-orbs {
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        overflow: hidden;
      }

      .bg-orb {
        position: absolute;
        width: 380px;
        height: 380px;
        border-radius: 50%;
        filter: blur(60px);
        opacity: 0.35;
      }

      .bg-orb:nth-child(1) {
        background: #4f46e5;
        top: -80px;
        right: -100px;
      }

      .bg-orb:nth-child(2) {
        background: #ec4899;
        bottom: -100px;
        left: -80px;
      }

      .bg-orb:nth-child(3) {
        background: #22c55e;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.18;
      }

      .card {
        width: 100%;
        max-width: 460px;
        padding: 28px 26px 30px;
        border-radius: 26px;
        background: rgba(15, 23, 42, 0.78);
        border: 1px solid rgba(148, 163, 184, 0.25);
        backdrop-filter: blur(22px);
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.9);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 18px;
      }

      .brand-logo {
        width: 38px;
        height: 38px;
        border-radius: 16px;
        background: radial-gradient(circle at 20% 20%, #a855f7, #0ea5e9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }

      .brand-text-title {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.04em;
      }

      .brand-text-sub {
        font-size: 12px;
        color: #cbd5f5;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 6px;
      }

      .subtitle {
        font-size: 13px;
        color: #cbd5f5;
        margin-bottom: 18px;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      label {
        font-size: 13px;
        color: #e5e7eb;
      }

      .input-wrapper {
        position: relative;
      }

      .input-wrapper i {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 14px;
      }

      .input-wrapper i.left {
        right: 12px;
      }

      .input-wrapper i.toggle-password {
        left: 12px;
        cursor: pointer;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="date"] {
        width: 100%;
        padding: 10px 36px 10px 36px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.78);
        color: #f9fafb;
        font-size: 13px;
        outline: none;
        transition: border 0.18s, box-shadow 0.18s, background 0.18s;
      }

      input::placeholder {
        color: #6b7280;
      }

      input:focus {
        border-color: #38bdf8;
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
        background: rgba(15, 23, 42, 0.98);
      }

      /* شكل القوائم المنسدلة لتطابق حقول الإدخال */
      select {
        width: 100%;
        padding: 10px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.78);
        color: #f9fafb;
        font-size: 13px;
        outline: none;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        transition: border 0.18s, box-shadow 0.18s, background 0.18s;
      }

      select:focus {
        border-color: #38bdf8;
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
        background: rgba(15, 23, 42, 0.98);
      }

      .birth-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1.2fr; /* يوم - شهر - سنة */
        gap: 8px;
      }

      .tiny {
        font-size: 11px;
        color: #9ca3af;
      }

      .row-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .terms-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 4px;
      }

      .terms-wrapper input {
        margin-top: 2px;
        width: 14px;
        height: 14px;
      }

      .terms-wrapper span {
        font-size: 12px;
        color: #d1d5db;
      }

      .terms-wrapper a {
        color: #38bdf8;
      }

      .btn-primary {
        margin-top: 6px;
        width: 100%;
        padding: 10px 0;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #0ea5e9, #6366f1);
        color: white;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          filter 0.12s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(59, 130, 246, 0.45);
        filter: brightness(1.03);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: none;
        filter: brightness(0.98);
      }

      .footer-txt {
        margin-top: 14px;
        font-size: 12px;
        text-align: center;
        color: #9ca3af;
      }

      .footer-txt a {
        color: #38bdf8;
      }

      .alert {
        margin-bottom: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 12px;
      }

      .alert-error {
        background: rgba(248, 113, 113, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.5);
        color: #fecaca;
      }

      .alert-success {
        background: rgba(52, 211, 153, 0.12);
        border: 1px solid rgba(52, 211, 153, 0.6);
        color: #bbf7d0;
      }

      .resend-link {
        margin-top: 6px;
        font-size: 12px;
        color: #38bdf8;
        text-align: center;
        cursor: pointer;
      }

      .resend-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 520px) {
        .card {
          margin: 16px;
          padding: 22px 18px 24px;
          border-radius: 22px;
        }

        h1 {
          font-size: 18px;
        }

        .row-2 {
          grid-template-columns: 1fr;
        }

        .birth-row {
          grid-template-columns: 1fr 1fr;
        }

        .birth-row .year-col {
          grid-column: 1 / 3; /* السنة تاخد سطر كامل على الموبايل */
        }
      }
    </style>
</head>
<body>
<div class="bg-orbs">
<div class="bg-orb"></div>
<div class="bg-orb"></div>
<div class="bg-orb"></div>
</div>
<div class="card">
<div class="brand">
<div class="brand-logo">S</div>
<div>
<div class="brand-text-title">Saepel</div>
<div class="brand-text-sub">انضم إلى مجتمع Saepel ✨</div>
</div>
</div>
<h1>إنشاء حساب جديد</h1>
<p class="subtitle">أنشئ حسابك وابدأ مشاركة أفكارك مع الآخرين.</p>
<div class="alert" id="registerMessage" style="display: none"></div>
<form id="registerForm">
<div class="field">
<label for="username">اسم المستخدم</label>
<div class="input-wrapper">
<i class="fa-regular fa-user left"></i>
<input id="username" placeholder="اكتب اسم يظهر للآخرين" required="" type="text"/>
</div>
<span class="tiny">يمكن أن يحتوي على حروف وأرقام و _</span>
</div>
<div class="field">
<label for="email">البريد الإلكتروني</label>
<div class="input-wrapper">
<i class="fa-regular fa-envelope left"></i>
<input autocomplete="email" id="email" placeholder="example@domain.com" required="" type="email"/>
</div>
</div>
<!-- تاريخ الميلاد: ٣ قوائم منسدلة -->
<div class="field">
<label>تاريخ الميلاد</label>
<div class="birth-row">
<!-- اليوم -->
<div class="input-wrapper">
<select id="birthDay">
<option value="">اليوم</option>
</select>
</div>
<!-- الشهر -->
<div class="input-wrapper">
<select id="birthMonth">
<option value="">الشهر</option>
</select>
</div>
<!-- السنة -->
<div class="input-wrapper year-col">
<select id="birthYear">
<option value="">السنة</option>
</select>
</div>
</div>
<span class="tiny">
            يجب أن يكون عمرك 13 سنة أو أكثر لاستخدام Saepel.
          </span>
</div>
<div class="row-2">
<div class="field">
<label for="password">كلمة المرور</label>
<div class="input-wrapper">
<i class="fa-solid fa-lock left"></i>
<input autocomplete="new-password" id="password" placeholder="كلمة مرور قوية" required="" type="password"/>
<i class="fa-regular fa-eye toggle-password" id="togglePassword"></i>
</div>
<span class="tiny">
              استخدم أحرف كبيرة وصغيرة وأرقام ورموز لزيادة الأمان.
            </span>
</div>
<div class="field">
<label for="confirmPassword">تأكيد كلمة المرور</label>
<div class="input-wrapper">
<i class="fa-solid fa-check left"></i>
<input id="confirmPassword" placeholder="أعد إدخال كلمة المرور" required="" type="password"/>
</div>
</div>
</div>
<div class="terms-wrapper">
<input id="terms" type="checkbox"/>
<span>
            أوافق على
            <a href="#" target="_blank">شروط الاستخدام</a>
            و
            <a href="#" target="_blank">سياسة الخصوصية</a>
            الخاصة بمنصة Saepel.
          </span>
</div>
<button class="btn-primary" id="registerBtn" type="submit">
          إنشاء الحساب
        </button>
</form>
<p class="footer-txt">
        عندك حساب بالفعل؟ <a href="login.html">تسجيل الدخول</a>
</p>
<div class="resend-link" id="resendSection" style="display: none">
        لم يصلك بريد التفعيل؟ اضغط هنا لإعادة الإرسال.
      </div>
</div>
<script>

      // ✅ استخدام نفس الدومين اللي الصفحة شغّالة منه
      const ORIGIN = window.location.origin;
      const DEFAULT_API_BASE = (ORIGIN && ORIGIN !== "null") ? (ORIGIN + "/api") : "https://backend-social-media-1ininin.onrender.com/api";
      // تقدر تغيّر الـ API Base مؤقتاً من الكونسول: localStorage.setItem("SAEPEL_API_BASE","https://.../api")
      const API_BASE = window.SAEPEL_API_BASE || localStorage.getItem("SAEPEL_API_BASE") || DEFAULT_API_BASE;

      async function safeReadJson(res) {
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          try { return await res.json(); } catch { return null; }
        }
        try { return { message: await res.text() }; } catch { return null; }
      }


      const registerForm = document.getElementById("registerForm");
      const registerMessage = document.getElementById("registerMessage");
      const registerBtn = document.getElementById("registerBtn");
      const resendSection = document.getElementById("resendSection");

      const passwordInput = document.getElementById("password");
      const confirmPasswordInput =
        document.getElementById("confirmPassword");
      const togglePassword = document.getElementById("togglePassword");

      togglePassword.addEventListener("click", () => {
        const isPassword = passwordInput.type === "password";
        passwordInput.type = isPassword ? "text" : "password";
        togglePassword.classList.toggle("fa-eye");
        togglePassword.classList.toggle("fa-eye-slash");
      });

      function showRegisterMessage(text, type = "error") {
        registerMessage.style.display = "block";
        registerMessage.textContent = text;
        registerMessage.className =
          "alert " + (type === "error" ? "alert-error" : "alert-success");
      }

      function calcAge(dateStr) {
        const today = new Date();
        const birth = new Date(dateStr);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age;
      }

      // تعبئة قوائم اليوم/الشهر/السنة
      function fillBirthSelects() {
        const daySelect = document.getElementById("birthDay");
        const monthSelect = document.getElementById("birthMonth");
        const yearSelect = document.getElementById("birthYear");

        // أيام 1–31
        for (let d = 1; d <= 31; d++) {
          const opt = document.createElement("option");
          opt.value = String(d);
          opt.textContent = d;
          daySelect.appendChild(opt);
        }

        // شهور
        const months = [
          "يناير",
          "فبراير",
          "مارس",
          "أبريل",
          "مايو",
          "يونيو",
          "يوليو",
          "أغسطس",
          "سبتمبر",
          "أكتوبر",
          "نوفمبر",
          "ديسمبر",
        ];

        months.forEach((name, index) => {
          const opt = document.createElement("option");
          opt.value = String(index + 1); // 1-12
          opt.textContent = name;
          monthSelect.appendChild(opt);
        });

        // سنوات (من الآن رجوعاً لـ 100 سنة تقريباً)
        const currentYear = new Date().getFullYear();
        const minYear = currentYear - 100;

        for (let y = currentYear - 13; y >= minYear; y--) {
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = y;
          yearSelect.appendChild(opt);
        }
      }

      // استدعاء تعبئة القوائم بعد تحميل الصفحة
      fillBirthSelects();

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();

        const birthDay = document.getElementById("birthDay").value;
        const birthMonth = document.getElementById("birthMonth").value;
        const birthYear = document.getElementById("birthYear").value;

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const termsChecked = document.getElementById("terms").checked;

        // تحقق أساسي
        if (
          !username ||
          !email ||
          !birthDay ||
          !birthMonth ||
          !birthYear ||
          !password ||
          !confirmPassword
        ) {
          showRegisterMessage("الرجاء ملء جميع الحقول.", "error");
          return;
        }

        // تحويل تاريخ الميلاد إلى YYYY-MM-DD
        const birthdate =
          birthYear +
          "-" +
          String(birthMonth).padStart(2, "0") +
          "-" +
          String(birthDay).padStart(2, "0");

        // تحقق من تطابق كلمة المرور
        if (password !== confirmPassword) {
          showRegisterMessage("كلمتا المرور غير متطابقتين.", "error");
          return;
        }

        // تحقق العمر
        const age = calcAge(birthdate);
        if (isNaN(age) || age < 13) {
          showRegisterMessage(
            "يجب أن يكون عمرك 13 سنة أو أكثر لاستخدام Saepel.",
            "error"
          );
          return;
        }

        // تحقق من الموافقة على الشروط
        if (!termsChecked) {
          showRegisterMessage(
            "يجب الموافقة على الشروط وسياسة الخصوصية للمتابعة.",
            "error"
          );
          return;
        }

        registerBtn.disabled = true;
        registerBtn.textContent = "جاري إنشاء الحساب...";

        try {
          const res = await fetch(API_BASE + "/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username,
              email,
              birthdate,
              password,
            }),
          });

          const data = (await safeReadJson(res)) || {};

          if (!res.ok) {
            showRegisterMessage(
              data.msg || data.message || "حدث خطأ أثناء إنشاء الحساب.",
              "error"
            );
          } else {
            // السيرفر عندك فعلاً فيه راوت resend-verify-email
            showRegisterMessage(
              "تم إنشاء الحساب بنجاح! تم إرسال رسالة تأكيد إلى بريدك الإلكتروني، الرجاء فتح الرابط لتفعيل الحساب.",
              "success"
            );

            resendSection.style.display = "block";

            // حفظ الإيميل مؤقتاً لإعادة إرسال التفعيل
            sessionStorage.setItem("pendingVerifyEmail", email);
          }
        } catch (err) {
          console.error(err);
          showRegisterMessage(
            "حدث خطأ غير متوقع، حاول مرة أخرى.",
            "error"
          );
        } finally {
          registerBtn.disabled = false;
          registerBtn.textContent = "إنشاء الحساب";
        }
      });

      // إعادة إرسال بريد التفعيل
      resendSection.addEventListener("click", async () => {
        const email = sessionStorage.getItem("pendingVerifyEmail");
        if (!email) {
          showRegisterMessage(
            "لا يوجد بريد مسجّل لإعادة الإرسال.",
            "error"
          );
          return;
        }

        try {
          const res = await fetch(API_BASE + "/auth/resend-verify-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          const data = (await safeReadJson(res)) || {};

          if (!res.ok) {
            showRegisterMessage(
              data.msg || "تعذّر إعادة إرسال البريد.",
              "error"
            );
          } else {
            showRegisterMessage(
              "تم إعادة إرسال رسالة التفعيل إلى بريدك.",
              "success"
            );
          }
        } catch (err) {
          console.error(err);
          showRegisterMessage(
            "حدث خطأ غير متوقع أثناء إعادة الإرسال.",
            "error"
          );
        }
      });
    
</script>
</body>
</html>
